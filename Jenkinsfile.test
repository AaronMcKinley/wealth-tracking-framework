pipeline {
  agent any
  environment {
    CYPRESS_BASE_URL = "https://wealth-tracking-framework.com"
    REPORT_NAME      = "Smoke Tests"
    CYPRESS_WORKDIR  = "wtf-cypress"
    CYPRESS_IMAGE    = "custom-cypress:13.11"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Cypress Docker Image') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          sh "docker build --no-cache -t ${CYPRESS_IMAGE} ."
        }
      }
    }

    stage('Run Cypress Smoke Tests') {
      steps {
        ansiColor('xterm') {
          script {
            def containerName = "cypress_runner_${BUILD_NUMBER}"
            try {
              sh "docker run -it -d --name ${containerName} ${CYPRESS_IMAGE} tail -f /dev/null"
              sh "docker exec ${containerName} npx cypress run --e2e --browser chrome --headless --spec 'smoke/**/*.cy.js'"
              sh "docker cp ${containerName}:/app/allure-results/. ${WORKSPACE}/${CYPRESS_WORKDIR}/allure-results"
            } finally {
              sh "docker stop ${containerName}"
              sh "docker rm ${containerName}"
            }
          }
        }
      }
    }

    stage('Allure Report') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          allure([
            results: [[path: 'allure-results']],
            reportBuildPolicy: 'ALWAYS'
          ])
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: "${CYPRESS_WORKDIR}/cypress/videos/**,${CYPRESS_WORKDIR}/cypress/screenshots/**,${CYPRESS_WORKDIR}/allure-report/**", allowEmptyArchive: true
    }
  }
}