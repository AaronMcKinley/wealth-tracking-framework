pipeline {
  agent any
  environment {
    CYPRESS_BASE_URL = "https://wealth-tracking-framework.com"
    REPORT_NAME      = "Smoke Tests"
    CYPRESS_WORKDIR  = "wtf-cypress"
    CYPRESS_IMAGE    = "custom-cypress:13.11"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build Cypress Docker Image') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          sh "docker build --no-cache -t ${CYPRESS_IMAGE} ."
        }
      }
    }

    stage('Run Cypress Smoke Tests') {
      steps {
        ansiColor('xterm') {
          dir("${CYPRESS_WORKDIR}") {
            sh '''
              set -euxo pipefail
              mkdir -p allure-results cypress/screenshots cypress/videos
              docker run --rm \
                --shm-size=2g \
                -u $(id -u):$(id -g) \
                -e FORCE_COLOR=1 \
                -e CI=1 \
                -e CYPRESS_baseUrl="'${CYPRESS_BASE_URL}'" \
                -v "$PWD":/e2e \
                -w /e2e \
                ${CYPRESS_IMAGE} \
                bash -lc "
                  npm ci
                  npx cypress run --e2e --browser chrome --headless --spec 'smoke/**/*.cy.js'
                "

              echo "Allure results count:"
              ls -1 allure-results | wc -l || true
            '''
          }
        }
      }
    }

    stage('Allure Report') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          allure(
            results: [[path: 'allure-results']],
            reportBuildPolicy: 'ALWAYS'
          )
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: "${CYPRESS_WORKDIR}/cypress/videos/**,${CYPRESS_WORKDIR}/cypress/screenshots/**,${CYPRESS_WORKDIR}/allure-report/**", allowEmptyArchive: true
    }
  }
}