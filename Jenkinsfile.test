pipeline {
  agent any
  environment {
    CYPRESS_BASE_URL = "https://wealth-tracking-framework.com"
    REPORT_NAME      = "Smoke Tests"
    CYPRESS_WORKDIR  = "wtf-cypress"
    CYPRESS_IMAGE    = "custom-cypress:13.11"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build Cypress Docker Image') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          sh "docker build --no-cache -t ${CYPRESS_IMAGE} ."
        }
      }
    }

    stage('Run Cypress Smoke Tests') {
      steps {
        ansiColor('xterm') {
          dir("${CYPRESS_WORKDIR}") {
            sh """
              rm -rf allure-results cypress/screenshots cypress/videos
              mkdir -p allure-results cypress/screenshots cypress/videos

              docker run --rm \
                --shm-size=2g \
                -u \$(id -u):\$(id -g) \
                -e CI=1 \
                ${CYPRESS_IMAGE} \
                bash -lc 'echo "=== support/e2e.js ==="; sed -n "1,40p" /app/support/e2e.js || true; echo "=== plugin version ==="; node -p "require(\\"@shelex/cypress-allure-plugin/package.json\\").version"'

              docker run --rm \
                --shm-size=2g \
                -u \$(id -u):\$(id -g) \
                -e FORCE_COLOR=1 \
                -e CI=1 \
                -e CYPRESS_BASE_URL=${CYPRESS_BASE_URL} \
                -e CYPRESS_allure=true \
                -e CYPRESS_allureResultsPath=allure-results \
                -v "\$PWD/allure-results":/app/allure-results \
                -v "\$PWD/cypress/screenshots":/app/cypress/screenshots \
                -v "\$PWD/cypress/videos":/app/cypress/videos \
                ${CYPRESS_IMAGE} \
                npx cypress run --e2e --browser chrome --headless --spec 'smoke/**/*.cy.js'

              echo "Allure results count:"
              count=\$(ls -1 allure-results 2>/dev/null | wc -l || true)
              echo "\$count"
              test "\$count" -gt 0 || { echo 'No Allure results generated'; exit 1; }
            """
          }
        }
      }
    }

    stage('Allure Report') {
      steps {
        dir("${CYPRESS_WORKDIR}") {
          allure(results: [[path: 'allure-results']], reportBuildPolicy: 'ALWAYS')
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: "${CYPRESS_WORKDIR}/cypress/videos/**,${CYPRESS_WORKDIR}/cypress/screenshots/**,${CYPRESS_WORKDIR}/allure-report/**", allowEmptyArchive: true
    }
  }
}
